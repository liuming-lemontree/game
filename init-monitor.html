<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>初始化监控 - 反诈先锋</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .monitor-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-pending { background: #ffc107; }
        .status-success { background: #28a745; }
        .status-error { background: #dc3545; }
        .module-item {
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            background: #f8f9fa;
            border-left: 4px solid #dee2e6;
        }
        .module-item.success { border-left-color: #28a745; }
        .module-item.error { border-left-color: #dc3545; }
        .log-container {
            background: #1a1a1a;
            color: #00ff00;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .refresh-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        .refresh-btn:hover { background: #0056b3; }
    </style>
</head>
<body>
    <h1>《反诈先锋》初始化监控</h1>

    <div class="monitor-container">
        <h2>初始化状态</h2>
        <div id="init-status">
            <div class="status-indicator status-pending"></div>
            等待初始化开始...
        </div>
        <button class="refresh-btn" onclick="refreshStatus()">刷新状态</button>
    </div>

    <div class="monitor-container">
        <h2>模块状态</h2>
        <div id="modules-status">
            <p>正在加载模块状态...</p>
        </div>
    </div>

    <div class="monitor-container">
        <h2>全局变量检查</h2>
        <div id="globals-status">
            <p>正在检查全局变量...</p>
        </div>
    </div>

    <div class="monitor-container">
        <h2>实时日志</h2>
        <div class="log-container" id="log-container">
            <div>等待日志输出...</div>
        </div>
    </div>

    <div class="monitor-container">
        <h2>快速操作</h2>
        <button class="refresh-btn" onclick="window.open('./index.html', '_blank')">打开游戏</button>
        <button class="refresh-btn" onclick="window.open('./test.html', '_blank')">运行测试</button>
        <button class="refresh-btn" onclick="forceReinit()">强制重新初始化</button>
    </div>

    <!-- 加载必要的脚本 -->
    <script src="js/device-adaptation.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/scenarios.js"></script>
    <script src="js/tutorial.js"></script>
    <script src="js/game.js"></script>
    <script src="js/debug.js"></script>
    <script src="js/init.js"></script>

    <script>
        let logMessages = [];

        // 重写console.log来捕获日志
        const originalLog = console.log;
        console.log = function(...args) {
            originalLog.apply(console, args);
            addLogMessage('LOG', args.join(' '));
        };

        // 重写console.error来捕获错误
        const originalError = console.error;
        console.error = function(...args) {
            originalError.apply(console, args);
            addLogMessage('ERROR', args.join(' '));
        };

        // 重写console.warn来捕获警告
        const originalWarn = console.warn;
        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addLogMessage('WARN', args.join(' '));
        };

        function addLogMessage(level, message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] [${level}] ${message}`;
            logMessages.push(logEntry);

            // 保持最新的50条消息
            if (logMessages.length > 50) {
                logMessages.shift();
            }

            updateLogDisplay();
        }

        function updateLogDisplay() {
            const logContainer = document.getElementById('log-container');
            logContainer.innerHTML = logMessages.map(msg =>
                `<div>${msg}</div>`
            ).join('');

            // 滚动到底部
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function refreshStatus() {
            updateInitStatus();
            updateModulesStatus();
            updateGlobalsStatus();
        }

        function updateInitStatus() {
            const statusDiv = document.getElementById('init-status');

            if (typeof initManager !== 'undefined') {
                const status = initManager.getStatus();
                const percentage = Math.round((status.initializedModules / status.totalModules) * 100);

                statusDiv.innerHTML = `
                    <div class="status-indicator ${status.initializedModules === status.totalModules ? 'status-success' : 'status-pending'}"></div>
                    初始化进度: ${status.initializedModules}/${status.totalModules} (${percentage}%)
                    ${status.errors.length > 0 ? `<br><span style="color: #dc3545;">错误数量: ${status.errors.length}</span>` : ''}
                `;
            } else {
                statusDiv.innerHTML = `
                    <div class="status-indicator status-error"></div>
                    初始化管理器未加载
                `;
            }
        }

        function updateModulesStatus() {
            const modulesDiv = document.getElementById('modules-status');
            const modules = [
                { name: 'storage', global: 'storage', class: 'StorageManager' },
                { name: 'ScenarioManager', global: 'ScenarioManager', class: 'ScenarioManager' },
                { name: 'tutorial', global: 'tutorial', class: 'TutorialManager' },
                { name: 'game', global: 'game', class: 'AntiFraudGame' },
                { name: 'debugManager', global: 'debugManager', class: 'DebugManager' }
            ];

            modulesDiv.innerHTML = modules.map(module => {
                const isClassDefined = typeof window[module.class] !== 'undefined';
                const isGlobalDefined = typeof window[module.global] !== 'undefined';
                const status = isGlobalDefined ? 'success' : (isClassDefined ? 'pending' : 'error');
                const statusText = isGlobalDefined ? '已初始化' : (isClassDefined ? '等待初始化' : '未定义');

                return `
                    <div class="module-item ${status}">
                        <strong>${module.name}</strong>:
                        <span class="status-indicator status-${status}"></span>
                        ${statusText}
                    </div>
                `;
            }).join('');
        }

        function updateGlobalsStatus() {
            const globalsDiv = document.getElementById('globals-status');
            const globals = ['game', 'tutorial', 'storage', 'debugManager', 'initManager'];

            const status = globals.map(globalName => {
                const exists = typeof window[globalName] !== 'undefined';
                return `<div class="module-item ${exists ? 'success' : 'error'}">
                    <strong>${globalName}</strong>:
                    <span class="status-indicator ${exists ? 'status-success' : 'status-error'}"></span>
                    ${exists ? '存在' : '不存在'}
                </div>`;
            }).join('');

            globalsDiv.innerHTML = status;
        }

        function forceReinit() {
            if (confirm('确定要强制重新初始化吗？这将清除所有当前状态。')) {
                // 清除现有的全局变量
                delete window.game;
                delete window.tutorial;
                delete window.storage;
                delete window.debugManager;
                delete window.initManager;

                // 重新加载页面
                location.reload();
            }
        }

        // 定期刷新状态
        setInterval(refreshStatus, 2000);

        // 监听初始化完成事件
        window.addEventListener('gameInitialized', () => {
            addLogMessage('INFO', '🎉 游戏初始化完成！');
            refreshStatus();
        });

        // 页面加载完成后开始监控
        window.addEventListener('load', () => {
            addLogMessage('INFO', '页面加载完成，开始监控');
            setTimeout(refreshStatus, 500);
        });

        // 初始刷新
        setTimeout(refreshStatus, 1000);
    </script>
</body>
</html>