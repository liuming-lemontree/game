<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆå§‹åŒ–ç›‘æ§ - åè¯ˆå…ˆé”‹</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .monitor-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-pending { background: #ffc107; }
        .status-success { background: #28a745; }
        .status-error { background: #dc3545; }
        .module-item {
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            background: #f8f9fa;
            border-left: 4px solid #dee2e6;
        }
        .module-item.success { border-left-color: #28a745; }
        .module-item.error { border-left-color: #dc3545; }
        .log-container {
            background: #1a1a1a;
            color: #00ff00;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .refresh-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        .refresh-btn:hover { background: #0056b3; }
    </style>
</head>
<body>
    <h1>ã€Šåè¯ˆå…ˆé”‹ã€‹åˆå§‹åŒ–ç›‘æ§</h1>

    <div class="monitor-container">
        <h2>åˆå§‹åŒ–çŠ¶æ€</h2>
        <div id="init-status">
            <div class="status-indicator status-pending"></div>
            ç­‰å¾…åˆå§‹åŒ–å¼€å§‹...
        </div>
        <button class="refresh-btn" onclick="refreshStatus()">åˆ·æ–°çŠ¶æ€</button>
    </div>

    <div class="monitor-container">
        <h2>æ¨¡å—çŠ¶æ€</h2>
        <div id="modules-status">
            <p>æ­£åœ¨åŠ è½½æ¨¡å—çŠ¶æ€...</p>
        </div>
    </div>

    <div class="monitor-container">
        <h2>å…¨å±€å˜é‡æ£€æŸ¥</h2>
        <div id="globals-status">
            <p>æ­£åœ¨æ£€æŸ¥å…¨å±€å˜é‡...</p>
        </div>
    </div>

    <div class="monitor-container">
        <h2>å®æ—¶æ—¥å¿—</h2>
        <div class="log-container" id="log-container">
            <div>ç­‰å¾…æ—¥å¿—è¾“å‡º...</div>
        </div>
    </div>

    <div class="monitor-container">
        <h2>å¿«é€Ÿæ“ä½œ</h2>
        <button class="refresh-btn" onclick="window.open('./index.html', '_blank')">æ‰“å¼€æ¸¸æˆ</button>
        <button class="refresh-btn" onclick="window.open('./test.html', '_blank')">è¿è¡Œæµ‹è¯•</button>
        <button class="refresh-btn" onclick="forceReinit()">å¼ºåˆ¶é‡æ–°åˆå§‹åŒ–</button>
    </div>

    <!-- åŠ è½½å¿…è¦çš„è„šæœ¬ -->
    <script src="js/device-adaptation.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/scenarios.js"></script>
    <script src="js/tutorial.js"></script>
    <script src="js/game.js"></script>
    <script src="js/debug.js"></script>
    <script src="js/init.js"></script>

    <script>
        let logMessages = [];

        // é‡å†™console.logæ¥æ•è·æ—¥å¿—
        const originalLog = console.log;
        console.log = function(...args) {
            originalLog.apply(console, args);
            addLogMessage('LOG', args.join(' '));
        };

        // é‡å†™console.erroræ¥æ•è·é”™è¯¯
        const originalError = console.error;
        console.error = function(...args) {
            originalError.apply(console, args);
            addLogMessage('ERROR', args.join(' '));
        };

        // é‡å†™console.warnæ¥æ•è·è­¦å‘Š
        const originalWarn = console.warn;
        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addLogMessage('WARN', args.join(' '));
        };

        function addLogMessage(level, message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] [${level}] ${message}`;
            logMessages.push(logEntry);

            // ä¿æŒæœ€æ–°çš„50æ¡æ¶ˆæ¯
            if (logMessages.length > 50) {
                logMessages.shift();
            }

            updateLogDisplay();
        }

        function updateLogDisplay() {
            const logContainer = document.getElementById('log-container');
            logContainer.innerHTML = logMessages.map(msg =>
                `<div>${msg}</div>`
            ).join('');

            // æ»šåŠ¨åˆ°åº•éƒ¨
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function refreshStatus() {
            updateInitStatus();
            updateModulesStatus();
            updateGlobalsStatus();
        }

        function updateInitStatus() {
            const statusDiv = document.getElementById('init-status');

            if (typeof initManager !== 'undefined') {
                const status = initManager.getStatus();
                const percentage = Math.round((status.initializedModules / status.totalModules) * 100);

                statusDiv.innerHTML = `
                    <div class="status-indicator ${status.initializedModules === status.totalModules ? 'status-success' : 'status-pending'}"></div>
                    åˆå§‹åŒ–è¿›åº¦: ${status.initializedModules}/${status.totalModules} (${percentage}%)
                    ${status.errors.length > 0 ? `<br><span style="color: #dc3545;">é”™è¯¯æ•°é‡: ${status.errors.length}</span>` : ''}
                `;
            } else {
                statusDiv.innerHTML = `
                    <div class="status-indicator status-error"></div>
                    åˆå§‹åŒ–ç®¡ç†å™¨æœªåŠ è½½
                `;
            }
        }

        function updateModulesStatus() {
            const modulesDiv = document.getElementById('modules-status');
            const modules = [
                { name: 'storage', global: 'storage', class: 'StorageManager' },
                { name: 'ScenarioManager', global: 'ScenarioManager', class: 'ScenarioManager' },
                { name: 'tutorial', global: 'tutorial', class: 'TutorialManager' },
                { name: 'game', global: 'game', class: 'AntiFraudGame' },
                { name: 'debugManager', global: 'debugManager', class: 'DebugManager' }
            ];

            modulesDiv.innerHTML = modules.map(module => {
                const isClassDefined = typeof window[module.class] !== 'undefined';
                const isGlobalDefined = typeof window[module.global] !== 'undefined';
                const status = isGlobalDefined ? 'success' : (isClassDefined ? 'pending' : 'error');
                const statusText = isGlobalDefined ? 'å·²åˆå§‹åŒ–' : (isClassDefined ? 'ç­‰å¾…åˆå§‹åŒ–' : 'æœªå®šä¹‰');

                return `
                    <div class="module-item ${status}">
                        <strong>${module.name}</strong>:
                        <span class="status-indicator status-${status}"></span>
                        ${statusText}
                    </div>
                `;
            }).join('');
        }

        function updateGlobalsStatus() {
            const globalsDiv = document.getElementById('globals-status');
            const globals = ['game', 'tutorial', 'storage', 'debugManager', 'initManager'];

            const status = globals.map(globalName => {
                const exists = typeof window[globalName] !== 'undefined';
                return `<div class="module-item ${exists ? 'success' : 'error'}">
                    <strong>${globalName}</strong>:
                    <span class="status-indicator ${exists ? 'status-success' : 'status-error'}"></span>
                    ${exists ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}
                </div>`;
            }).join('');

            globalsDiv.innerHTML = status;
        }

        function forceReinit() {
            if (confirm('ç¡®å®šè¦å¼ºåˆ¶é‡æ–°åˆå§‹åŒ–å—ï¼Ÿè¿™å°†æ¸…é™¤æ‰€æœ‰å½“å‰çŠ¶æ€ã€‚')) {
                // æ¸…é™¤ç°æœ‰çš„å…¨å±€å˜é‡
                delete window.game;
                delete window.tutorial;
                delete window.storage;
                delete window.debugManager;
                delete window.initManager;

                // é‡æ–°åŠ è½½é¡µé¢
                location.reload();
            }
        }

        // å®šæœŸåˆ·æ–°çŠ¶æ€
        setInterval(refreshStatus, 2000);

        // ç›‘å¬åˆå§‹åŒ–å®Œæˆäº‹ä»¶
        window.addEventListener('gameInitialized', () => {
            addLogMessage('INFO', 'ğŸ‰ æ¸¸æˆåˆå§‹åŒ–å®Œæˆï¼');
            refreshStatus();
        });

        // é¡µé¢åŠ è½½å®Œæˆåå¼€å§‹ç›‘æ§
        window.addEventListener('load', () => {
            addLogMessage('INFO', 'é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹ç›‘æ§');
            setTimeout(refreshStatus, 500);
        });

        // åˆå§‹åˆ·æ–°
        setTimeout(refreshStatus, 1000);
    </script>
</body>
</html>