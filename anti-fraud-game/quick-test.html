<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>快速功能测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 0;
        }
        .test-button:hover {
            background: #5a6fd8;
        }
        #results {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 14px;
            line-height: 1.4;
        }
        .loading {
            color: #666;
            font-style: italic;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>🧪 《反诈先锋》快速功能测试</h1>

        <p>这个页面将测试游戏的核心功能，包括：</p>
        <ul>
            <li>全局对象初始化</li>
            <li>场景数据完整性</li>
            <li>本地存储功能</li>
            <li>游戏核心功能</li>
            <li>教程系统</li>
            <li>场景管理器</li>
            <li>DOM元素完整性</li>
            <li>CSS样式加载</li>
            <li>设备适配</li>
            <li>错误处理机制</li>
        </ul>

        <button class="test-button" onclick="runTests()">开始测试</button>
        <button class="test-button" onclick="openGame()">打开游戏</button>

        <div id="status" class="status" style="display: none;"></div>
        <div id="results" class="loading">点击"开始测试"按钮开始功能测试...</div>
    </div>

    <!-- 加载游戏资源 -->
    <script src="js/device-adaptation.js"></script>
    <script src="js/performance.js"></script>
    <script src="js/touch-enhancement.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/scenarios.js"></script>
    <script src="js/tutorial.js"></script>
    <script src="js/game.js"></script>
    <script src="js/debug.js"></script>
    <script src="js/init.js"></script>

    <script>
        // 等待初始化完成
        let initCheckInterval;

        function waitForInitialization() {
            return new Promise((resolve) => {
                initCheckInterval = setInterval(() => {
                    if (window.game && window.storage && window.tutorial) {
                        clearInterval(initCheckInterval);
                        resolve();
                    }
                }, 100);

                // 超时保护
                setTimeout(() => {
                    clearInterval(initCheckInterval);
                    resolve();
                }, 5000);
            });
        }

        function showStatus(message, isError = false) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${isError ? 'error' : 'success'}`;
            statusDiv.style.display = 'block';
        }

        async function runTests() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.textContent = '⏳ 正在加载测试脚本...';

            try {
                // 等待游戏初始化
                await waitForInitialization();

                // 清空控制台并显示开始信息
                console.clear();
                console.log('🧪 开始《反诈先锋》游戏功能测试...\n');

                resultsDiv.textContent = '⏳ 正在执行测试，请查看控制台获取详细信息...';

                // 重定向console.log到页面
                const originalLog = console.log;
                let logs = [];
                console.log = function(...args) {
                    originalLog.apply(console, args);
                    logs.push(args.join(' '));
                    resultsDiv.textContent = logs.join('\n');
                };

                // 加载并执行测试脚本
                const script = document.createElement('script');
                script.src = 'test-functionality.js';
                script.onload = () => {
                    setTimeout(() => {
                        // 恢复console.log
                        console.log = originalLog;

                        if (window.gameTestResults) {
                            const results = window.gameTestResults;
                            if (results.failed === 0) {
                                showStatus(`✅ 所有测试通过！(${results.passed}/${results.tests.length})`);
                            } else {
                                showStatus(`❌ 部分测试失败 (${results.failed}/${results.tests.length})`, true);
                            }
                        }
                    }, 2000);
                };
                document.head.appendChild(script);

            } catch (error) {
                resultsDiv.textContent = `❌ 测试执行失败: ${error.message}`;
                showStatus(`测试执行失败: ${error.message}`, true);
            }
        }

        function openGame() {
            window.open('index.html', '_blank');
        }

        // 页面加载完成后的初始化检查
        window.addEventListener('load', () => {
            setTimeout(() => {
                if (window.game && window.storage && window.tutorial) {
                    showStatus('✅ 游戏资源加载完成，可以开始测试');
                } else {
                    showStatus('⚠️ 游戏资源仍在加载中，请稍后再试', true);
                }
            }, 1000);
        });
    </script>
</body>
</html>